FROM python:3.9-slim

WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (netcat ì¶”ê°€)
RUN apt-get update && apt-get install -y \
    gcc \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements-producers.txt .
RUN pip install --no-cache-dir -r requirements-producers.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY apps/ ./apps/
COPY configs/ ./configs/

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/logs

# ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •
WORKDIR /app/apps/producers

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHONPATH=/app
ENV CONFIG_FILE=/app/configs/config-docker.yaml

# Kafka ëŒ€ê¸° í›„ producers ì‹¤í–‰ (í† í”½ì€ Kafka auto-createë¡œ ìë™ ìƒì„±ë¨)
CMD ["bash", "-c", "\
    echo 'ğŸš€ Crypto Producers ì‹œì‘ ì¤‘...' && \
    echo 'ğŸ“¡ Kafka ì—°ê²° ëŒ€ê¸° ì¤‘...' && \
    while ! nc -z kafka 29092; do \
        echo 'â³ Kafka ëŒ€ê¸° ì¤‘...' && \
        sleep 5; \
    done && \
    echo 'âœ… Kafka ì—°ê²° í™•ì¸ë¨' && \
    echo 'â³ Kafka ë‚´ë¶€ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...' && \
    sleep 15 && \
    echo 'ğŸ¯ Crypto Producers ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (í† í”½ì€ ìë™ ìƒì„±ë¨)' && \
    python main.py \
"]